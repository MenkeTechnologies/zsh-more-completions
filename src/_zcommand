#compdef z zshz

local arguments zcmd

exists(){
    #alternative is command -v
    type "$1" &>/dev/null || return 1 && \
    type "$1" 2>/dev/null | \
    command grep -qv "suffix alias" 2>/dev/null
}


arguments=(
       '-c[restrict matches to subdirectories of the current directory]'
       '-e[echo the best match, do not cd]'
       '-h[show a brief help message]'
       '-l[list only]'
       '-r[match by rank only]'
       '-t[match by recent access only]'
       '-x[remove the current directory from the datafile]'
        '1:command:->command'
        '*::options:->options'
)

local curcontext="$curcontext" state state_descr line expl
local tmp ret=1

if exists zshz; then
    zcmd=zshz
elif exists _z; then
    zcmd=_z
else
    return 1
fi

__display(){
    if exists fasd;then
        _alternative \
            'zdir:z ranked directories:(('"$($zcmd -l |& perl -e '@l=reverse<>;do{print "$2\\:\"$1\" "if/^\s*(\S+)\s+(\S+)\s*$/}for@l')"'))' \
            'fasd:fasd ranked directories:(('"$(fasd -d |& perl -e '@l=reverse<>;do{print "$2\\:\"$1\" "if/^\s*(\S+)\s+(\S+)\s*$/}for@l')"'))' \
            'files:directory:_path_files -g ".*(/) *(/)"'
    else
        _alternative \
            'zdir:z ranked directories:(('"$($zcmd -l |& perl -e '@l=reverse<>;do{print "$2\\:\"$1\" "if/^\s*(\S+)\s+(\S+)\s*$/}for@l')"'))' \
            'files:directory:_path_files -g ".*(/) *(/)"'
    fi
}

_arguments -s -C : $arguments && return 0

case "$state" in
    command)
        __display && return 0
        ;;
    options)
        _message "no more arguments for z"
        return 1
        ;;
esac

